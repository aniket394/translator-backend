from flask import Flask, request, jsonify
from flask_cors import CORS
from dotenv import load_dotenv
import os
import jwt
import time

app = Flask(__name__)
CORS(app)

# Load .env file
load_dotenv()

LIVEKIT_API_KEY = os.getenv("LIVEKIT_API_KEY")
LIVEKIT_API_SECRET = os.getenv("LIVEKIT_API_SECRET")
LIVEKIT_URL = os.getenv("LIVEKIT_URL")

@app.route("/livekit-token", methods=["GET"])
def livekit_token():
    try:
        if not LIVEKIT_API_KEY or not LIVEKIT_API_SECRET or not LIVEKIT_URL:
            return jsonify({"error": "LiveKit not configured"}), 500

        # Query params
        identity = request.args.get("identity", "student1")
        room = request.args.get("room", "translation-room")

        # JWT payload
        payload = {
            "iss": LIVEKIT_API_KEY,
            "sub": identity,
            "exp": int(time.time()) + 3600,  # expires in 1 hour
            "video": {"room_join": True, "room": room}
        }

        token = jwt.encode(payload, LIVEKIT_API_SECRET, algorithm="HS256")
        if isinstance(token, bytes):
            token = token.decode("utf-8")

        return jsonify({
            "token": token,
            "room": room,
            "url": LIVEKIT_URL
        })

    except Exception as e:
        return jsonify({"error": str(e)}), 500

if __name__ == "__main__":
    print("LiveKit service running on port 6000")
    app.run(host="0.0.0.0", port=6000, debug=True)
